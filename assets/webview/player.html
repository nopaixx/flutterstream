<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveVaultHub P2P Player - Debug Version</title>

    <!-- Import Maps for P2P Media Loader -->
    <script type="importmap">
        {
            "imports": {
                "p2p-media-loader-core": "https://cdn.jsdelivr.net/npm/p2p-media-loader-core@^2/dist/p2p-media-loader-core.es.min.js",
                "p2p-media-loader-hlsjs": "https://cdn.jsdelivr.net/npm/p2p-media-loader-hlsjs@^2/dist/p2p-media-loader-hlsjs.es.min.js"
            }
        }
    </script>

    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@~1/dist/hls.min.js"></script>

    <!-- Vidstack Player -->
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css" />
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #player-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #player {
            width: 100%;
            height: 100%;
            --media-brand: #6B46C1;
            --media-focus-ring: #8B5CF6;
        }

        .debug-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
            z-index: 2000;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
        }

        .p2p-stats {
            position: absolute;
            top: 60px;
            right: 16px;
            background: linear-gradient(135deg, rgba(107, 70, 193, 0.95), rgba(139, 92, 246, 0.95));
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 11px;
            font-family: monospace;
            z-index: 1000;
            min-width: 200px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .p2p-stats.hidden {
            display: none;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0F0F0F, #1F1F23);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-direction: column;
            z-index: 1500;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(107, 70, 193, 0.2);
            border-top: 4px solid #6B46C1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-direction: column;
            z-index: 2000;
        }

        .error-overlay.hidden {
            display: none;
        }
    </style>
</head>
<body>
<div id="player-container">
    <!-- Debug Panel -->
    <div id="debug-panel" class="debug-panel">
        <div id="debug-content">üîç Debug Panel Activo</div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <div>üöÄ Iniciando LiveVaultHub Player</div>
        <div style="font-size: 14px; margin-top: 8px;">Conectando red P2P...</div>
    </div>

    <!-- Error Overlay -->
    <div id="error" class="error-overlay hidden">
        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
        <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">Error de Reproducci√≥n</div>
        <div id="error-message" style="font-size: 14px; margin-bottom: 24px;">No se pudo cargar el video</div>
        <button onclick="retryLoad()" style="background: linear-gradient(135deg, #6B46C1, #8B5CF6); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Reintentar</button>
    </div>

    <!-- P2P Stats -->
    <div id="p2p-stats" class="p2p-stats hidden">
        <div style="font-weight: bold; margin-bottom: 8px;">P2P Network</div>
        <div>Estado: <span id="p2p-status">Connecting...</span></div>
        <div>Peers: <span id="peer-count">0</span></div>
        <div>Descargado: <span id="downloaded">0 MB</span></div>
        <div>Ratio P2P: <span id="p2p-ratio">0%</span></div>
    </div>

    <!-- Vidstack Player -->
    <div id="player"></div>
</div>

<script type="module">
    import {
        VidstackPlayer,
        VidstackPlayerLayout,
    } from "https://cdn.vidstack.io/player";

    class LiveVaultHubPlayer {
        constructor() {
            this.player = null;
            this.currentUrl = null;
            this.isLive = false;
            this.debug = true;
            this.currentState = 'initializing';
            this.isWeb = typeof window !== 'undefined' && !window.flutter_inappwebview;
            this.messageQueue = [];

            this.debugLog('üé¨ Constructor called', { isWeb: this.isWeb });
            this.init();
        }

        debugLog(message, data = null) {
            console.log('[LiveVaultHub]', message, data || '');

            // Mostrar en debug panel
            const debugContent = document.getElementById('debug-content');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}${data ? ' ' + JSON.stringify(data) : ''}`;
            debugContent.innerHTML = logEntry + '<br>' + debugContent.innerHTML;

            // Limitar a 10 l√≠neas
            const lines = debugContent.innerHTML.split('<br>');
            if (lines.length > 10) {
                debugContent.innerHTML = lines.slice(0, 10).join('<br>');
            }
        }

        async init() {
            try {
                this.debugLog('üöÄ Player initializing...');
                await this.setupPlayer();
                this.setupMessageListener();
                this.notifyFlutter('player_ready');
                this.debugLog('‚úÖ Player initialized successfully');
            } catch (error) {
                this.debugLog('‚ùå Failed to initialize player:', error);
                this.showError('Error al inicializar el reproductor');
            }
        }

        async setupPlayer() {
            this.debugLog('üì∫ Creating Vidstack player...');

            this.player = await VidstackPlayer.create({
                target: "#player",
                crossOrigin: true,
                playsInline: true,
                layout: new VidstackPlayerLayout(),
            });

            this.setupPlayerEvents();
            this.debugLog('üì∫ Vidstack player created successfully');
        }

        setupMessageListener() {
            this.debugLog('üé¨ Setting up message listener...');

            // Para web
            if (this.isWeb) {
                this.debugLog('üåê Web environment detected');

                // ‚úÖ NUEVO: DOM EVENT LISTENER PARA FLUTTER
                this.debugLog('üîß Setting up DOM event listener for flutter-message...');
                document.addEventListener('flutter-message', (event) => {
                    this.debugLog('üì® DOM Event received:', event.detail);
                    this.handleFlutterMessage(event.detail);
                });

                // Fallback: window message listener
                window.addEventListener('message', (event) => {
                    if (event.data && event.data.action) {
                        this.debugLog('üì• Received window message from Flutter:', event.data);
                        this.handleFlutterMessage(event.data);
                    }
                });

                // Funci√≥n global para enviar mensajes
                window.sendToFlutter = (data) => {
                    this.debugLog('üì§ Sending via postMessage:', data);
                    window.postMessage(data, '*');
                };

                // Test inmediato de comunicaci√≥n
                setTimeout(() => {
                    this.debugLog('üß™ Testing communication...');
                    this.notifyFlutter('player_ready');
                }, 100);

                this.debugLog('‚úÖ DOM event listener configured');
            }

            // Para m√≥vil
            if (window.flutter_inappwebview) {
                this.debugLog('üì± Mobile environment detected');
                window.flutter_inappwebview.callHandler('FlutterBridge', JSON.stringify({
                    type: 'player_ready',
                    timestamp: Date.now()
                }));
            }
        }

        setupPlayerEvents() {
            this.player.addEventListener('provider-change', (event) => {
                const provider = event.detail;
                this.debugLog('üì∫ Provider changed:', provider?.type || 'undefined');
            });

            this.player.addEventListener('loadstart', () => {
                this.debugLog('üì∫ Video load started');
                this.notifyFlutter('video_loading', { url: this.currentUrl });
            });

            this.player.addEventListener('loadedmetadata', () => {
                this.debugLog('üì∫ Video metadata loaded');
                this.hideLoading();
                this.notifyFlutter('loadedmetadata', {
                    duration: this.player.duration || 0
                });
            });

            this.player.addEventListener('canplay', () => {
                this.debugLog('üì∫ Video can play');
                this.notifyFlutter('video_ready');
            });

            this.player.addEventListener('play', () => {
                this.debugLog('üì∫ Video playing');
                this.notifyFlutter('play');
            });

            this.player.addEventListener('pause', () => {
                this.debugLog('üì∫ Video paused');
                this.notifyFlutter('pause');
            });

            this.player.addEventListener('error', (e) => {
                this.debugLog('‚ùå Player error:', e);
                this.showError('Error de reproducci√≥n del video');
                this.notifyFlutter('error', { message: 'Error de reproducci√≥n' });
            });

            this.debugLog('‚úÖ Player events configured');
        }

        // ‚úÖ M√âTODO PRINCIPAL CORREGIDO
        async loadVideo(url, options = {}) {
            try {
                this.debugLog('üìπ LOADING VIDEO CALLED!', {
                    url: url,
                    options: options,
                    playerExists: !!this.player
                });

                this.currentUrl = url;
                this.isLive = options.isLive || url.includes('.m3u8');

                this.showLoading();
                this.hideError();

                // ‚úÖ VERIFICAR QUE EL PLAYER EXISTE
                if (!this.player) {
                    throw new Error('Player not initialized');
                }

                this.debugLog('üéØ Setting player.src...', { url });

                // ‚úÖ ASIGNAR URL AL PLAYER
                this.player.src = url;

                this.debugLog('‚úÖ Player.src assigned successfully');

                this.setState('connecting');

                this.notifyFlutter('video_loading', {
                    url: url,
                    isLive: this.isLive
                });

            } catch (error) {
                this.debugLog('‚ùå Error in loadVideo:', error);
                this.showError('Error al cargar el video: ' + error.message);
                this.notifyFlutter('error', { message: error.message });
            }
        }

        play() {
            this.debugLog('‚ñ∂Ô∏è Play called');
            this.player?.play().catch(e => {
                this.debugLog('‚ùå Play failed:', e);
                this.showError('No se pudo reproducir el video');
            });
        }

        pause() {
            this.debugLog('‚è∏Ô∏è Pause called');
            this.player?.pause();
        }

        seekTo(time) {
            this.debugLog('‚è© Seek called:', time);
            if (this.player) {
                this.player.currentTime = time;
            }
        }

        setState(newState) {
            if (this.currentState === newState) return;

            this.currentState = newState;
            this.debugLog('üîÑ State changed:', newState);

            document.getElementById('p2p-status').textContent = newState;
            this.notifyFlutter('state_changed', { state: newState });
        }

        showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        showError(message) {
            this.debugLog('‚ùå Showing error:', message);
            document.getElementById('error-message').textContent = message;
            document.getElementById('error').classList.remove('hidden');
            this.hideLoading();
            this.notifyFlutter('error', { message });
        }

        hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        notifyFlutter(type, data = {}) {
            const message = {
                type: type,
                ...data,
                timestamp: Date.now()
            };

            try {
                // Para m√≥vil/desktop
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler('FlutterBridge', JSON.stringify(message));
                }

                // Para web
                if (window.sendToFlutter) {
                    window.sendToFlutter(message);
                } else if (window.parent && window.parent.postMessage) {
                    window.parent.postMessage(message, '*');
                }

                this.debugLog('üì§ Sent to Flutter:', { type, data });
            } catch (error) {
                this.debugLog('‚ùå Error sending to Flutter:', error);
            }
        }

        // ‚úÖ MANEJO DE MENSAJES MEJORADO
        handleFlutterMessage(messageData) {
            try {
                this.debugLog('üì• RAW MESSAGE RECEIVED:', messageData);

                const data = typeof messageData === 'string' ? JSON.parse(messageData) : messageData;
                this.debugLog('üì• PARSED MESSAGE:', data);

                switch(data.action) {
                    case 'loadVideo':
                        this.debugLog('üéØ LOAD VIDEO ACTION RECEIVED!', {
                            url: data.url,
                            options: data.options
                        });
                        this.loadVideo(data.url, data.options || {});
                        break;
                    case 'play':
                        this.debugLog('‚ñ∂Ô∏è PLAY ACTION RECEIVED');
                        this.play();
                        break;
                    case 'pause':
                        this.debugLog('‚è∏Ô∏è PAUSE ACTION RECEIVED');
                        this.pause();
                        break;
                    case 'seekTo':
                        this.debugLog('‚è© SEEK ACTION RECEIVED:', data.time);
                        this.seekTo(data.time);
                        break;
                    default:
                        this.debugLog('‚ùì Unknown action:', data.action);
                }
            } catch (error) {
                this.debugLog('‚ùå Error handling Flutter message:', error);
            }
        }
    }

    // Global functions
    window.retryLoad = function() {
        window.lvhPlayer?.debugLog('üîÑ Retry load called');
        if (window.lvhPlayer && window.lvhPlayer.currentUrl) {
            window.lvhPlayer.loadVideo(window.lvhPlayer.currentUrl);
        }
    };

    window.sendMessageToPlayer = function(message) {
        window.lvhPlayer?.debugLog('üì® sendMessageToPlayer called:', message);
        if (window.lvhPlayer) {
            window.lvhPlayer.handleFlutterMessage(message);
        }
    };

    // ‚úÖ TEST GLOBAL PARA DEBUG
    window.testLoadVideo = function() {
        if (window.lvhPlayer) {
            window.lvhPlayer.debugLog('üß™ Testing loadVideo manually...');
            window.lvhPlayer.loadVideo('https://fcc3ddae59ed.us-west-2.playback.live-video.net/api/video/v1/us-west-2.893648527354.channel.DmumNckWFTqz.m3u8');
        }
    };

    // Initialize player
    window.addEventListener('load', () => {
        console.log('üöÄ Window load event - Creating player...');
        window.lvhPlayer = new LiveVaultHubPlayer();
    });
</script>
</body>
</html>