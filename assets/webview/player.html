<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveVaultHub P2P Player - FULL FIXED</title>

    <!-- ‚úÖ HLS.js PRIMERO -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@~1/dist/hls.min.js"></script>

    <!-- ‚úÖ Import Maps CORRECTOS para v2 -->
    <script type="importmap">
        {
            "imports": {
                "p2p-media-loader-core": "https://cdn.jsdelivr.net/npm/p2p-media-loader-core@^2/dist/p2p-media-loader-core.es.min.js",
                "p2p-media-loader-hlsjs": "https://cdn.jsdelivr.net/npm/p2p-media-loader-hlsjs@^2/dist/p2p-media-loader-hlsjs.es.min.js"
            }
        }
    </script>

    <!-- ‚úÖ Vidstack Player -->
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css" />
    <link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #player-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #player {
            width: 100%;
            height: 100%;
            --media-brand: #6B46C1;
            --media-focus-ring: #8B5CF6;
        }

        .debug-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
            z-index: 2000;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
        }

        .p2p-stats {
            position: absolute;
            top: 60px;
            right: 16px;
            background: linear-gradient(135deg, rgba(107, 70, 193, 0.95), rgba(139, 92, 246, 0.95));
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 11px;
            font-family: monospace;
            z-index: 1000;
            min-width: 200px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .p2p-stats.hidden {
            display: none;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0F0F0F, #1F1F23);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-direction: column;
            z-index: 1500;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(107, 70, 193, 0.2);
            border-top: 4px solid #6B46C1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-direction: column;
            z-index: 2000;
        }

        .error-overlay.hidden {
            display: none;
        }
    </style>
</head>
<body>
<div id="player-container">
    <!-- Debug Panel -->
    <div id="debug-panel" class="debug-panel">
        <div id="debug-content">üîç Debug Panel Activo</div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <div>üöÄ Iniciando LiveVaultHub P2P Player</div>
        <div style="font-size: 14px; margin-top: 8px;">Conectando red P2P...</div>
    </div>

    <!-- Error Overlay -->
    <div id="error" class="error-overlay hidden">
        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
        <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">Error de Reproducci√≥n</div>
        <div id="error-message" style="font-size: 14px; margin-bottom: 24px;">No se pudo cargar el video</div>
        <button onclick="retryLoad()" style="background: linear-gradient(135deg, #6B46C1, #8B5CF6); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Reintentar</button>
    </div>

    <!-- P2P Stats -->
    <div id="p2p-stats" class="p2p-stats hidden">
        <div style="font-weight: bold; margin-bottom: 8px;">P2P Network</div>
        <div>Estado: <span id="p2p-status">Connecting...</span></div>
        <div>Peers: <span id="peer-count">0</span></div>
        <div>Descargado: <span id="downloaded">0 MB</span></div>
        <div>Ratio P2P: <span id="p2p-ratio">0%</span></div>
    </div>

    <!-- Vidstack Player -->
    <div id="player"></div>
</div>

<!-- ‚úÖ GLOBAL BRIDGE SETUP -->
<script>
    console.log('üåâ Setting up global bridge...');

    // ‚úÖ GLOBAL STATE
    window.lvhState = {
        isInitialized: false,
        currentUrl: null,
        isLoading: false,
        hasError: false,
        playerInstance: null,
        p2pStats: { peers: 0, downloaded: 0, ratio: 0 }
    };

    // ‚úÖ COMMUNICATION QUEUES
    window.toFlutterQueue = [];
    window.fromFlutterQueue = [];

    // ‚úÖ SAFE DEBUG FUNCTION - AVOIDING CIRCULAR JSON
    window.debugLog = function(message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        let logMessage = `[${timestamp}] ${message}`;

        if (data) {
            try {
                // ‚úÖ SAFE JSON STRINGIFY
                const safeData = JSON.parse(JSON.stringify(data, (key, value) => {
                    if (typeof value === 'object' && value !== null) {
                        if (key.startsWith('$') || key === 'constructor' || key === '__proto__') {
                            return '[Filtered]';
                        }
                        // Skip complex objects that might have circular references
                        if (value.constructor && value.constructor.name &&
                            !['Object', 'Array', 'String', 'Number', 'Boolean'].includes(value.constructor.name)) {
                            return `[${value.constructor.name}]`;
                        }
                    }
                    return value;
                }));
                logMessage += ' ' + JSON.stringify(safeData);
            } catch (e) {
                logMessage += ' [Complex Object]';
            }
        }

        console.log('[LiveVaultHub Bridge]', logMessage);

        // Update debug panel
        const debugContent = document.getElementById('debug-content');
        if (debugContent) {
            debugContent.innerHTML = logMessage + '<br>' + debugContent.innerHTML;
            const lines = debugContent.innerHTML.split('<br>');
            if (lines.length > 10) {
                debugContent.innerHTML = lines.slice(0, 10).join('<br>');
            }
        }
    };

    // ‚úÖ BRIDGE FUNCTIONS FOR PARENT WINDOW
    window.sendToFlutter = function(data) {
        window.debugLog('üì§ Bridge sending to Flutter:', data);
        window.toFlutterQueue.push(JSON.stringify(data));

        // ‚úÖ ALSO try postMessage to parent
        try {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'player-event', data: data }, '*');
            }
        } catch (e) {
            window.debugLog('‚ö†Ô∏è postMessage failed:', e.message);
        }
    };

    // ‚úÖ RECEIVE MESSAGES FROM FLUTTER - MULTIPLE CHANNELS
    window.addEventListener('message', (event) => {
        if (event.data && event.data.action) {
            window.debugLog('üì• Bridge received window message:', event.data);
            window.processFlutterMessage(event.data);
        }
    });

    // ‚úÖ DOM EVENT LISTENER
    document.addEventListener('flutter-message', (event) => {
        window.debugLog('üì• Bridge received DOM event:', event.detail);
        window.processFlutterMessage(event.detail);
    });

    // ‚úÖ PROCESS FLUTTER MESSAGES
    window.processFlutterMessage = function(message) {
        window.debugLog('‚öôÔ∏è Processing Flutter message:', message);

        if (window.lvhState.playerInstance && window.lvhState.playerInstance.handleFlutterMessage) {
            window.lvhState.playerInstance.handleFlutterMessage(message);
        } else {
            window.debugLog('‚ö†Ô∏è Player not ready, message queued');
            window.fromFlutterQueue.push(message);
        }
    };

    // ‚úÖ GLOBAL FUNCTIONS FOR DEBUGGING (EXPOSED TO PARENT)
    window.getPlayerState = function() {
        const state = {
            bridge: {
                isInitialized: window.lvhState.isInitialized,
                currentUrl: window.lvhState.currentUrl,
                playerInstance: !!window.lvhState.playerInstance,
                queueSizes: {
                    toFlutter: window.toFlutterQueue.length,
                    fromFlutter: window.fromFlutterQueue.length
                }
            },
            player: window.lvhState.playerInstance ? {
                currentState: window.lvhState.playerInstance.currentState,
                isLive: window.lvhState.playerInstance.isLive,
                p2pStats: window.lvhState.p2pStats
            } : null
        };

        window.debugLog('üìä Current state:', state);
        return state;
    };

    window.testLoadVideo = function() {
        window.debugLog('üß™ Manual test load video');
        if (window.lvhState.playerInstance) {
            const testUrl = 'https://fcc3ddae59ed.us-west-2.playback.live-video.net/api/video/v1/us-west-2.893648527354.channel.DmumNckWFTqz.m3u8';
            window.lvhState.playerInstance.loadVideo(testUrl, { isLive: true });
        } else {
            window.debugLog('‚ùå Player instance not available');
        }
    };

    window.toggleP2PStats = function() {
        const stats = document.getElementById('p2p-stats');
        if (stats) {
            stats.classList.toggle('hidden');
            window.debugLog('üìä P2P stats toggled');
        }
    };

    window.retryLoad = function() {
        window.debugLog('üîÑ Retry load triggered');
        if (window.lvhState.currentUrl) {
            window.testLoadVideo();
        } else {
            window.debugLog('‚ùå No URL to retry');
        }
    };

    // ‚úÖ EXPOSE FUNCTIONS TO PARENT WINDOW
    try {
        if (window.parent && window.parent !== window) {
            window.parent.lvhPlayer = {
                getState: window.getPlayerState,
                testLoad: window.testLoadVideo,
                toggleStats: window.toggleP2PStats,
                retry: window.retryLoad
            };
            window.debugLog('‚úÖ Functions exposed to parent window');
        }
    } catch (e) {
        window.debugLog('‚ö†Ô∏è Could not expose to parent:', e.message);
    }

    window.debugLog('‚úÖ Global bridge setup complete');
</script>

<!-- ‚úÖ MAIN PLAYER MODULE -->
<script type="module">
    import {
        VidstackPlayer,
        VidstackPlayerLayout,
    } from "https://cdn.vidstack.io/player";

    // ‚úÖ IMPORTAR P2P Media Loader
    import { HlsJsP2PEngine } from "p2p-media-loader-hlsjs";

    class LiveVaultHubPlayer {
        constructor() {
            this.player = null;
            this.hlsInstance = null;
            this.p2pEngine = null;
            this.currentUrl = null;
            this.isLive = false;
            this.debug = true;
            this.currentState = 'initializing';
            this.isWeb = typeof window !== 'undefined' && !window.flutter_inappwebview;
            this.messageQueue = [];
            this.p2pStats = {
                peers: 0,
                downloaded: 0,
                ratio: 0
            };

            window.debugLog('üé¨ LiveVaultHub Player Constructor');
            this.init();
        }

        async init() {
            try {
                window.debugLog('üöÄ Player initializing...');
                window.lvhState.isLoading = true;

                // ‚úÖ SETUP P2P ENGINE
                await this.setupP2PEngine();

                // ‚úÖ SETUP VIDSTACK PLAYER
                await this.setupPlayer();

                // ‚úÖ SETUP COMMUNICATION
                this.setupMessageListener();

                // ‚úÖ PROCESS QUEUED MESSAGES
                this.processQueuedMessages();

                // ‚úÖ REGISTER GLOBALLY
                window.lvhState.playerInstance = this;
                window.lvhState.isInitialized = true;
                window.lvhState.isLoading = false;

                this.notifyFlutter('player_ready');
                window.debugLog('‚úÖ Player initialized successfully');

            } catch (error) {
                window.debugLog('‚ùå Failed to initialize player:', error);
                this.showError('Error al inicializar el reproductor P2P');
                window.lvhState.hasError = true;
                window.lvhState.isLoading = false;
            }
        }

        async setupP2PEngine() {
            try {
                window.debugLog('üî• Setting up P2P engine...');

                const isP2PSupported = HTMLScriptElement.supports && HTMLScriptElement.supports("importmap") && Hls.isSupported();

                if (isP2PSupported) {
                    this.HlsWithP2P = HlsJsP2PEngine.injectMixin(Hls);
                    window.debugLog('‚úÖ P2P HLS engine created successfully');
                    this.setState('connecting');
                } else {
                    window.debugLog('‚ö†Ô∏è P2P not supported, using regular HLS');
                    this.HlsWithP2P = Hls;
                    this.setState('disabled');
                }

            } catch (error) {
                window.debugLog('‚ùå P2P setup failed:', error);
                this.HlsWithP2P = Hls;
                this.setState('error');
            }
        }

        async setupPlayer() {
            window.debugLog('üì∫ Creating Vidstack player...');

            this.player = await VidstackPlayer.create({
                target: "#player",
                crossOrigin: true,
                playsInline: true,
                layout: new VidstackPlayerLayout(),
            });

            this.setupPlayerEvents();
            window.debugLog('üì∫ Vidstack player created successfully');
        }

        setupPlayerEvents() {
            // ‚úÖ PROVIDER CHANGE - KEY EVENT
            this.player.addEventListener('provider-change', (event) => {
                const provider = event.detail;
                window.debugLog('üì∫ Provider changed:', provider?.type || 'undefined');

                if (provider?.type === 'hls') {
                    window.debugLog('üî• Configuring HLS provider with P2P...');
                    provider.library = this.HlsWithP2P;

                    provider.config = {
                        p2p: {
                            core: {
                                swarmId: this.currentUrl ? this.generateSwarmId(this.currentUrl) : 'livevaulthub_default',
                                announceTrackers: [
                                    "wss://tracker.novage.com.ua:443/announce",
                                    "wss://tracker.webtorrent.dev:443/announce",
                                ],
                            },
                            onHlsJsCreated: (hls) => {
                                window.debugLog('üî• HLS.js instance created with P2P');
                                this.hlsInstance = hls;
                                this.setupP2PEventListeners(hls);
                                this.setupHLSEvents(hls);
                            },
                        },
                    };
                }
            });

            // ‚úÖ VIDEO EVENTS - VIDSTACK SPECIFIC
            this.player.addEventListener('loadstart', () => {
                window.debugLog('üì∫ Video load started');
                this.notifyFlutter('video_loading', { url: this.currentUrl });
            });

            this.player.addEventListener('loadedmetadata', () => {
                window.debugLog('üì∫ Video metadata loaded - HIDING LOADING');
                this.hideLoading();
                this.notifyFlutter('loadedmetadata', {
                    duration: this.player.duration || 0
                });
            });

            this.player.addEventListener('can-play', () => {
                window.debugLog('üì∫ Video can play');
                this.hideLoading();
                this.notifyFlutter('video_ready');
            });

            this.player.addEventListener('play', () => {
                window.debugLog('üì∫ Video playing');
                this.notifyFlutter('play');
            });

            this.player.addEventListener('pause', () => {
                window.debugLog('üì∫ Video paused');
                this.notifyFlutter('pause');
            });

            this.player.addEventListener('time-update', () => {
                this.notifyFlutter('timeupdate', {
                    currentTime: this.player.currentTime || 0
                });
            });

            this.player.addEventListener('ended', () => {
                window.debugLog('üì∫ Video ended');
                this.notifyFlutter('ended');
            });

            this.player.addEventListener('error', (e) => {
                window.debugLog('‚ùå Player error:', e);
                this.showError('Error de reproducci√≥n del video');
                this.notifyFlutter('error', { message: 'Error de reproducci√≥n' });
            });

            window.debugLog('‚úÖ Player events configured');
        }

        setupHLSEvents(hls) {
            window.debugLog('üéµ Setting up HLS.js events...');

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                window.debugLog('üìã HLS: Manifest parsed');
                this.hideLoading();
            });

            hls.on(Hls.Events.LEVEL_LOADED, () => {
                window.debugLog('üìä HLS: Level loaded');
            });

            hls.on(Hls.Events.FRAG_LOADED, () => {
                window.debugLog('üì¶ HLS: Fragment loaded');
            });

            hls.on(Hls.Events.ERROR, (event, data) => {
                window.debugLog('‚ùå HLS Error:', data);
                if (data.fatal) {
                    this.showError('Error cr√≠tico en HLS: ' + data.type);
                }
            });

            window.debugLog('‚úÖ HLS events configured');
        }

        setupP2PEventListeners(hls) {
            if (!hls.p2pEngine) {
                window.debugLog('‚ö†Ô∏è No P2P engine in HLS instance');
                return;
            }

            this.p2pEngine = hls.p2pEngine;

            this.p2pEngine.addEventListener("onPeerConnect", (details) => {
                window.debugLog('ü§ù Peer connected:', details.peerId);
                this.p2pStats.peers++;
                this.updateP2PStats();
                this.setState('connected');
                this.notifyFlutter('peer_connect', { peerId: details.peerId });
            });

            this.p2pEngine.addEventListener("onPeerDisconnect", (details) => {
                window.debugLog('üíî Peer disconnected:', details.peerId);
                this.p2pStats.peers = Math.max(0, this.p2pStats.peers - 1);
                this.updateP2PStats();
                this.notifyFlutter('peer_disconnect', { peerId: details.peerId });
            });

            this.p2pEngine.addEventListener("onSegmentLoaded", (details) => {
                if (details.source === 'p2p') {
                    this.p2pStats.downloaded += details.bytes || 0;
                    this.setState('sharing');
                }

                this.updateP2PStats();
                this.notifyFlutter('segment_loaded', {
                    source: details.source,
                    bytes: details.bytes
                });
            });

            window.debugLog('‚úÖ P2P event listeners configured');
        }

        generateSwarmId(url) {
            const cleanUrl = url.split('?')[0];
            return `livevaulthub_${btoa(cleanUrl).slice(0, 16)}`;
        }

        updateP2PStats() {
            const peerCountEl = document.getElementById('peer-count');
            const downloadedEl = document.getElementById('downloaded');
            const ratioEl = document.getElementById('p2p-ratio');

            if (peerCountEl) peerCountEl.textContent = this.p2pStats.peers;
            if (downloadedEl) downloadedEl.textContent = `${(this.p2pStats.downloaded / 1024 / 1024).toFixed(1)} MB`;

            const ratio = this.p2pStats.downloaded > 0 ? Math.min(80, this.p2pStats.peers * 20) : 0;
            if (ratioEl) ratioEl.textContent = `${ratio}%`;

            window.lvhState.p2pStats = {
                peers: this.p2pStats.peers,
                downloaded: this.p2pStats.downloaded,
                ratio: ratio
            };

            this.notifyFlutter('stats_update', {
                peers: this.p2pStats.peers,
                downloaded: this.p2pStats.downloaded,
                ratio: ratio
            });
        }

        setupMessageListener() {
            window.debugLog('üé¨ Setting up message listener...');

            if (this.isWeb) {
                window.debugLog('üåê Web environment detected');
                window.debugLog('‚úÖ Message listeners configured');
            }

            if (window.flutter_inappwebview) {
                window.debugLog('üì± Mobile environment detected');
                window.flutter_inappwebview.callHandler('FlutterBridge', JSON.stringify({
                    type: 'player_ready',
                    timestamp: Date.now()
                }));
            }
        }

        // ‚úÖ PROCESS QUEUED MESSAGES FROM FLUTTER
        processQueuedMessages() {
            if (window.fromFlutterQueue.length > 0) {
                window.debugLog('üîÑ Processing queued messages:', window.fromFlutterQueue.length);
                const messages = window.fromFlutterQueue.splice(0);
                messages.forEach(msg => this.handleFlutterMessage(msg));
            }
        }

        // ‚úÖ LOAD VIDEO - MAIN METHOD
        async loadVideo(url, options = {}) {
            try {
                window.debugLog('üìπ LOAD VIDEO CALLED!', {
                    url: url,
                    options: options,
                    playerExists: !!this.player
                });

                this.currentUrl = url;
                this.isLive = options.isLive || url.includes('.m3u8');
                window.lvhState.currentUrl = url;

                this.showLoading();
                this.hideError();

                if (!this.player) {
                    throw new Error('Player not initialized');
                }

                window.debugLog('üéØ Setting player.src = ' + url);

                // ‚úÖ ASSIGN URL TO PLAYER
                this.player.src = url;

                window.debugLog('‚úÖ Player.src assigned - should trigger provider-change');

                this.setState('connecting');

                // ‚úÖ TIMEOUT PARA FORZAR HIDE LOADING SI NO LLEGAN EVENTOS
                setTimeout(() => {
                    if (document.getElementById('loading') && !document.getElementById('loading').classList.contains('hidden')) {
                        window.debugLog('‚è∞ Timeout: Forcing hide loading after 10 seconds');
                        this.hideLoading();
                    }
                }, 10000);

                this.notifyFlutter('video_loading', {
                    url: url,
                    isLive: this.isLive
                });

            } catch (error) {
                window.debugLog('‚ùå Error in loadVideo:', error);
                this.showError('Error al cargar el video: ' + error.message);
                this.notifyFlutter('error', { message: error.message });
            }
        }

        play() {
            window.debugLog('‚ñ∂Ô∏è Play called');
            if (this.player) {
                this.player.play().catch(e => {
                    window.debugLog('‚ùå Play failed:', e);
                    this.showError('No se pudo reproducir el video');
                });
            }
        }

        pause() {
            window.debugLog('‚è∏Ô∏è Pause called');
            if (this.player) {
                this.player.pause();
            }
        }

        seekTo(time) {
            window.debugLog('‚è© Seek called:', time);
            if (this.player) {
                this.player.currentTime = time;
            }
        }

        setState(newState) {
            if (this.currentState === newState) return;

            this.currentState = newState;
            window.debugLog('üîÑ State changed:', newState);

            const statusEl = document.getElementById('p2p-status');
            if (statusEl) statusEl.textContent = newState;

            this.notifyFlutter('state_changed', { state: newState });
        }

        showLoading() {
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
                loadingEl.classList.remove('hidden');
                window.debugLog('‚è≥ Loading overlay shown');
            }
        }

        hideLoading() {
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
                loadingEl.classList.add('hidden');
                window.debugLog('‚úÖ Loading overlay hidden');
            }
        }

        showError(message) {
            window.debugLog('‚ùå Showing error:', message);
            const errorEl = document.getElementById('error');
            const errorMsgEl = document.getElementById('error-message');

            if (errorMsgEl) errorMsgEl.textContent = message;
            if (errorEl) errorEl.classList.remove('hidden');

            this.hideLoading();
            this.notifyFlutter('error', { message });
        }

        hideError() {
            const errorEl = document.getElementById('error');
            if (errorEl) errorEl.classList.add('hidden');
        }

        notifyFlutter(type, data = {}) {
            const message = {
                type: type,
                ...data,
                timestamp: Date.now()
            };

            try {
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler('FlutterBridge', JSON.stringify(message));
                }

                window.sendToFlutter(message);
                window.debugLog('üì§ Sent to Flutter:', { type, data });
            } catch (error) {
                window.debugLog('‚ùå Error sending to Flutter:', error);
            }
        }

        // ‚úÖ HANDLE FLUTTER MESSAGES
        handleFlutterMessage(messageData) {
            try {
                window.debugLog('üì• PROCESSING MESSAGE:', messageData);

                const data = typeof messageData === 'string' ? JSON.parse(messageData) : messageData;
                window.debugLog('üì• PARSED MESSAGE:', data);

                switch(data.action) {
                    case 'loadVideo':
                        window.debugLog('üéØ LOAD VIDEO ACTION - EXECUTING!', {
                            url: data.url,
                            options: data.options
                        });
                        this.loadVideo(data.url, data.options || {});
                        break;
                    case 'play':
                        window.debugLog('‚ñ∂Ô∏è PLAY ACTION');
                        this.play();
                        break;
                    case 'pause':
                        window.debugLog('‚è∏Ô∏è PAUSE ACTION');
                        this.pause();
                        break;
                    case 'seekTo':
                        window.debugLog('‚è© SEEK ACTION:', data.time);
                        this.seekTo(data.time);
                        break;
                    default:
                        window.debugLog('‚ùì Unknown action:', data.action);
                }
            } catch (error) {
                window.debugLog('‚ùå Error handling Flutter message:', error);
            }
        }
    }

    // ‚úÖ CREATE PLAYER INSTANCE
    window.addEventListener('load', () => {
        console.log('üöÄ Window load event - Creating player...');

        try {
            const player = new LiveVaultHubPlayer();
            window.debugLog('‚úÖ Player instance created and registered globally');
        } catch (error) {
            console.error('‚ùå Failed to create player:', error);
            window.debugLog('‚ùå Failed to create player instance:', error);
        }
    });

    // ‚úÖ HEARTBEAT FOR MONITORING
    setInterval(() => {
        if (window.lvhState.isInitialized) {
            window.debugLog(`üíì Heartbeat - Player: ${window.lvhState.isInitialized ? 'Ready' : 'Not Ready'}, URL: ${window.lvhState.currentUrl || 'None'}`);
        }
    }, 30000);
</script>
</body>
</html>